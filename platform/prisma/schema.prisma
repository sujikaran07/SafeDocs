datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -----------------------------------------------------------------------------
// User & Auth
// -----------------------------------------------------------------------------
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?    // Optional for OAuth users
  name          String?
  role          Role      @default(USER)
  
  // OAuth fields
  emailVerified DateTime?
  image         String?
  
  // Account Status
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?

  // Subscription & Billing (Stripe)
  plan                  Plan     @default(FREE)
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique

  // Relations
  scans         Scan[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]
  subscription  Subscription?
  accounts      Account[]
  sessions      Session[]
  notifications Notification[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

// NextAuth Models
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Role {
  USER
  ADMIN
}

// -----------------------------------------------------------------------------
// Security & Scanning
// -----------------------------------------------------------------------------
model Scan {
  id              String   @id @default(uuid())
  
  // Ownership
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // File Metadata
  filename        String
  contentType     String?
  sizeBytes       Int      @default(0)
  sha256          String?
  
  // Verdict
  verdict         Verdict  @default(PENDING)
  riskScore       Float    @default(0.0)
  
  // Paths (Local Storage)
  originalPath    String?
  cleanPath       String?
  cleanFilename   String?
  
  // Full Report (Stored as JSONB)
  report          Json?

  // Scanning Metadata
  engineVersion   String?
  processingTime  Float?   // in seconds
  
  // Relations
  fileCleanup     FileCleanup?
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([sha256])
  @@index([verdict])
  @@index([createdAt])
}

enum Verdict {
  PENDING
  BENIGN
  MALICIOUS
  SUSPICIOUS
  ERROR
}

// -----------------------------------------------------------------------------
// API Access (For Developers/Integrations)
// -----------------------------------------------------------------------------
model ApiKey {
  id          String   @id @default(uuid())
  key         String   @unique // Hashed
  name        String?  // e.g. "Production Server"
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
}

// -----------------------------------------------------------------------------
// Billing & Subscriptions
// -----------------------------------------------------------------------------
model Subscription {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  plan            Plan     @default(FREE)
  status          SubscriptionStatus @default(ACTIVE)
  
  // Payment Integration (Stripe)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  
  // Billing Period
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean  @default(false)
  canceledAt         DateTime?
  
  // Usage Limits (denormalized for quick access)
  monthlyScansLimit  Int      @default(3)   // FREE: 3, PRO: 100, ENTERPRISE: unlimited (-1)
  monthlyScansUsed   Int      @default(0)
  lastResetAt        DateTime @default(now())
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  payments        Payment[]
  usageTracking   UsageTracking[]
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([plan])
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

// -----------------------------------------------------------------------------
// Usage Tracking (Monthly Quotas)
// -----------------------------------------------------------------------------
model UsageTracking {
  id              String   @id @default(uuid())
  
  userId          String
  subscriptionId  String
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  month           Int      // 1-12
  year            Int      // 2025
  
  scansUsed       Int      @default(0)
  scansLimit      Int      @default(3)
  
  apiCallsUsed    Int      @default(0)
  apiCallsLimit   Int      @default(100)
  
  storageUsedMB   Float    @default(0)
  storageLimitMB  Float    @default(100)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([subscriptionId, year, month])
  @@index([userId])
}

// -----------------------------------------------------------------------------
// Payment History
// -----------------------------------------------------------------------------
model Payment {
  id                 String   @id @default(uuid())
  
  subscriptionId     String
  subscription       Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  // Payment Details
  stripePaymentId    String   @unique
  amount             Float    // in dollars
  currency           String   @default("usd")
  status             PaymentStatus @default(PENDING)
  
  // Invoice
  invoiceUrl         String?
  receiptUrl         String?
  
  // Metadata
  description        String?
  failureReason      String?
  
  paidAt             DateTime?
  createdAt          DateTime @default(now())
  
  @@index([subscriptionId])
  @@index([status])
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELED
}

// -----------------------------------------------------------------------------
// Notifications
// -----------------------------------------------------------------------------
model Notification {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType @default(INFO)
  title       String
  message     String
  
  // Links
  actionUrl   String?
  actionLabel String?
  
  // Status
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SCAN_COMPLETE
  QUOTA_WARNING
  QUOTA_EXCEEDED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELED
}

// -----------------------------------------------------------------------------
// Password Reset
// -----------------------------------------------------------------------------
model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  otp       String?  // 6-digit OTP
  
  expiresAt DateTime
  usedAt    DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([token])
}

// -----------------------------------------------------------------------------
// File Cleanup (Auto-deletion after 48 hours)
// -----------------------------------------------------------------------------
model FileCleanup {
  id              String   @id @default(uuid())
  
  scanId          String   @unique
  scan            Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  // File paths to delete
  originalPath    String?
  cleanPath       String?
  
  // Deletion schedule
  scheduledFor    DateTime // 48 hours after scan
  deletedAt       DateTime?
  status          CleanupStatus @default(PENDING)
  
  createdAt       DateTime @default(now())
  
  @@index([scheduledFor, status])
}

enum CleanupStatus {
  PENDING
  COMPLETED
  FAILED
}

// -----------------------------------------------------------------------------
// Webhook Logs (Stripe, Payment providers)
// -----------------------------------------------------------------------------
model WebhookLog {
  id          String   @id @default(uuid())
  
  provider    String   // "stripe", "paypal", etc.
  event       String   // "payment.succeeded", "subscription.updated"
  payload     Json     // Full webhook payload
  
  processed   Boolean  @default(false)
  processedAt DateTime?
  error       String?
  
  createdAt   DateTime @default(now())
  
  @@index([provider, event])
  @@index([processed])
}

// -----------------------------------------------------------------------------
// Audit & Compliance
// -----------------------------------------------------------------------------
model AuditLog {
  id        String   @id @default(uuid())
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action    String   // e.g. "LOGIN", "SCAN_FILE", "DELETE_ACCOUNT", "UPGRADE_PLAN"
  details   Json?    // Extra metadata (IP address, User Agent, etc.)
  
  ipAddress String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
